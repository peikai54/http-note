## 三次握手与四次挥手

### 三次握手

http 协议是一个超文本传输协议，它不会处理计算机之间的寻址问题和通信、数据丢失问题。而 TCP 协议的三次握手，就是在建立 TCP 连接之前，确保客户端服务端的接受、发送功能正常的一个手段。

两台计算机建立连接之前，客户端和服务端都需要确认对方的信息接收能力、信息发送能力都正常，才会建立连接传输数据。那么三次握手是怎么做到这一点的呢？

下面这张图简单地说明了三次握手的过程:

![avatar](https://for-wp.obs.cn-south-1.myhuaweicloud.com:443/1155312401-1.jpg?AccessKeyId=0FBSS4ODLZBACMCPJGBG&Expires=1710789407&Signature=hwnlaA7bHij%2BxK8gqSPpOumaiZM%3D)

三次握手的过程与目的详解：

#### 第一次握手

第一次握手是由客户端向服务端发送一个 SYN(synchronous 建立联机号) 字段。这个字段是为了确保后面能根服务端进行正确的连接,并生成一个随机的 seq x 给 服务器。在服务端接收到 SYN 字段后，服务端得到了一个信息： 客户端的发送能力是正常的。

#### 第二次握手

第二次握手是在服务端得到客户端的 SYN 字段后，向客户端发送一个 ACK(acknowledgement 确认)字段，然后随机生成一个 seq 字段 y，同时 ack 取客户端发送过来 seq 的值 + 1，也就是 x + 1。这时候，客户端得到 ack 字段 x + 1 以后，说明客户端可得知，服务端接收功能正常，发送功能也正常。但这时，服务端尚未得知客户端接收功能是否正常，因此没有建立连接。

#### 第三次握手

客户端向服务端发送 ACK 字段，ACK 值同样为服务端 seq 值 + 1， 也就是 y + 1。服务端收到客户端的 ACK 后，也确认了客户端的接收能力正常，因此开启连接。

也就是说，正常的三次握手里，第一次握手服务端可以确信客户端的发送能力正常，第二次握手客户端确信服务端的发送、接受能力正常，第三次握手服务端确定客户端的接收能力正常。

#### 为什么需要第三次握手

1. 避免历史连接。

如果第一次握手时，客户端因为网络阻塞，第一个 SYN 请求没有很快发送到服务端。那么一段时间后客户端会再次发送 SYN 请求。服务端先收到了第一个 SYN 请求，因此回复了第一个 ACK，这时客户端收到 ACK 中 seq 的值时，明白改 ACK 回复的是第一个已经被废弃的 SYN 请求，因此可以向服务端中断连接。

2. 初始化序列号

序列号初始化以后可以避免数据包丢失或重复等问题，也可以避免数据包乱序。

3. 避免资源浪费

如果没有第三次握手 ACK 回应，服务端在发出 SYN 后不能确定客户端是否收到，可能每过一段时间都会重复发起 SYN 请求建立连接。

### 四次挥手

TCP 关闭连接时，需要进行四次挥手操作。具体流程如下

1. 客户端发送一个 FIN 段，并包含一个希望接收者看到的自己当前的序列号 K. 同时还包含一个 ACK 表示确认对方最近一次发过来的数据。
2. 服务端将 K 值加 1 作为 ACK 序号值，表明收到了上一个包。这时上层的应用程序会被告知另一端发起了关闭操作，通常这将引起应用程序发起自己的关闭操作。
3. 服务端发起自己的 FIN 段，ACK=K+1, Seq=L
4. 客户端确认。ACK=L+1

#### 第一次挥手

第一次挥手由客户端向服务端发送 FIN 段，表示想要关闭连接。客户端进入 FIN_WAIT_1 状态，表明已经没有信息要发送给服务端了。

#### 第二次挥手

服务端向客户端发送 ACK 字段，表明已经接收到客户端想要停止连接的请求。但第二次挥手的目的，并不表明服务端已经准备结束连接，服务端可能还有想要发送的数据。

#### 第三次挥手

服务端在发送完所有数据后。向客户端发送 FIN 字段，表明服务端也完成了请求处理，将会关闭连接。

#### 第四次挥手

客户端接收到服务端的关闭请求后，向服务端发送 ACK 字段，表明已经接收到了关闭请求。服务端接收到 ACK 后关闭连接，客户端在等待 2MSL 后若没有收到回复则关闭连接。(避免服务端没有收到最后的 ACK 字段，向客户端再次发送 FIN 字段时，客户端已经关闭连接。因此需要等待 2MSL)
